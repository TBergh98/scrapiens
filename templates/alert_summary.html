<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Scrapiens - Riepilogo Elaborazione</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f9; color: #1c1c1c; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: 0 auto; padding: 24px; }
    .header { background: #1a5f7a; color: #ffffff; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .header h1 { margin: 0 0 8px 0; font-size: 24px; }
    .header p { margin: 0; font-size: 14px; opacity: 0.9; }
    .section { background: #ffffff; border: 1px solid #e1e4ea; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .section h2 { margin: 0 0 12px 0; font-size: 16px; color: #1a5f7a; border-bottom: 2px solid #1a5f7a; padding-bottom: 8px; }
    .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { font-weight: 600; color: #333; }
    .stat-value { font-size: 18px; font-weight: bold; color: #1a5f7a; }
    .stat-value.warning { color: #b35900; }
    .stat-value.error { color: #a80000; }
    .stat-value.success { color: #1d6f42; }
    .error-list { background: #fff5f5; border-left: 4px solid #a80000; padding: 12px; margin-top: 8px; border-radius: 4px; }
    .error-item { font-size: 13px; color: #555; margin-bottom: 6px; font-family: monospace; }
    .error-item:last-child { margin-bottom: 0; }
    .warn-list { background: #fffaf0; border-left: 4px solid #b35900; padding: 12px; margin-top: 8px; border-radius: 4px; }
    .warn-item { font-size: 13px; color: #6b4a00; margin-bottom: 6px; font-family: monospace; }
    .warn-item:last-child { margin-bottom: 0; }
    .success-badge { display: inline-block; background: #e5f5ec; color: #1d6f42; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; }
    .warning-badge { display: inline-block; background: #fff4e0; color: #b35900; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; }
    .error-badge { display: inline-block; background: #ffe6e6; color: #a80000; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; }
    .footer { text-align: center; color: #666; font-size: 12px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #e1e4ea; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Scrapiens - Riepilogo Elaborazione</h1>
      <p>Data/ora: {{ processing_date }}</p>
    </div>

    <div class="section">
      <h2>Estrazione Bandi</h2>
      <div class="stat-row">
        <span class="stat-label">Bandi estratti totali:</span>
        <span class="stat-value">{{ total_extracted_grants }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Bandi con estrazione riuscita:</span>
        <span class="stat-value success">{{ extraction_success }}/{{ total_extracted_grants }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Tasso di successo estrazione:</span>
        <span class="stat-value {% if extraction_success_rate >= 80 %}success{% elif extraction_success_rate >= 50 %}warning{% else %}error{% endif %}">{{ extraction_success_rate }}%</span>
      </div>
    </div>

    <div class="section">
      <h2>Matching Parole Chiave</h2>
      <div class="stat-row">
        <span class="stat-label">Bandi con match keyword:</span>
        <span class="stat-value">{{ grants_with_keyword_matches }}/{{ total_extracted_grants }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Tasso di match:</span>
        <span class="stat-value {% if match_rate >= 70 %}success{% elif match_rate >= 30 %}warning{% else %}error{% endif %}">{{ match_rate }}%</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Email nel sistema:</span>
        <span class="stat-value">{{ total_emails_in_system }}</span>
      </div>
    </div>

    <div class="section">
      <h2>Invio Digest</h2>
      <div class="stat-row">
        <span class="stat-label">Ricercatori con digest:</span>
        <span class="stat-value success">{{ total_recipients }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Bandi totali nei digest:</span>
        <span class="stat-value">{{ total_grants_in_digests }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Mail inviate con successo:</span>
        <span class="stat-value success">{{ successful_sends_count }}</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Mail fallite:</span>
        <span class="stat-value {% if failed_sends_count > 0 %}error{% else %}success{% endif %}">{{ failed_sends_count }}</span>
      </div>

      {% if failed_sends_count > 0 %}
      <div class="error-list">
        <strong>Dettagli errori invio:</strong>
        {% for error in failed_sends %}
        <div class="error-item">
          <strong>{{ error.recipient }}:</strong> {{ error.error }}
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    {% if warnings_count > 0 %}
    <div class="section">
      <h2>Avvisi da controllare</h2>
      <div class="warn-list">
        {% for w in warnings %}
        <div class="warn-item">• {{ w }}</div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="section" style="text-align: center;">
      <div style="margin-bottom: 8px;">
        {% if failed_sends_count == 0 and extraction_success_rate >= 80 and match_rate >= 30 %}
        <span class="success-badge">✓ Elaborazione completata con successo</span>
        {% elif failed_sends_count == 0 %}
        <span class="warning-badge">⚠ Elaborazione completata con avvisi</span>
        {% else %}
        <span class="error-badge">✗ Elaborazione completata con errori</span>
        {% endif %}
      </div>
    </div>

    <div class="footer">
      Questo è un riepilogo automatico della pipeline Scrapiens. Per dettagli, consultare i log locali.
    </div>
  </div>
</body>
</html>
